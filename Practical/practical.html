<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Clara Peiret-García">
<meta name="author" content="Anna Freni Sterrantino">
<meta name="author" content="Esra Suel">
<meta name="author" content="Adam Dennett">
<meta name="author" content="Gerard Casey">

<title>Mapping the Unseen: Small Area Estimation for Urban Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="practical_files/libs/clipboard/clipboard.min.js"></script>
<script src="practical_files/libs/quarto-html/quarto.js"></script>
<script src="practical_files/libs/quarto-html/popper.min.js"></script>
<script src="practical_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="practical_files/libs/quarto-html/anchor.min.js"></script>
<link href="practical_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="practical_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="practical_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="practical_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="practical_files/libs/bootstrap/bootstrap-973236bd072d72a04ee9cd82dcc9cb29.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Mapping the Unseen: Small Area Estimation for Urban Analysis</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Clara Peiret-García <a href="mailto:c.peiret-garcia@ucl.ac.uk" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Centre for Advanced Spatial Analysis, UCL
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Anna Freni Sterrantino </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Alan Turing Institute | Imperial College London
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Esra Suel </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Centre for Advanced Spatial Analysis, UCL
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Adam Dennett </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Centre for Advanced Spatial Analysis, UCL
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Gerard Casey </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Arup | Centre for Advanced Spatial Analysis, UCL
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<p>Please, make sure you have <code>R version 4.5.1 (2025-06-13)</code> installed in your laptop. You can download it from here: <a href="https://cran.r-project.org/" class="uri">https://cran.r-project.org/</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install required packages if not already installed</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>required_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sae"</span>, <span class="st">"emdi"</span>, <span class="st">"saeTrafo"</span>, <span class="st">"hbsae"</span>, <span class="st">"SUMMER"</span>, <span class="st">"survey"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dplyr"</span>, <span class="st">"tidyr"</span>, <span class="st">"purrr"</span>, <span class="st">"sf"</span>, </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggplot2"</span>, <span class="st">"hrbrthemes"</span>, <span class="st">"GGally"</span>, <span class="st">"patchwork"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>to_install <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(required_packages, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(to_install) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(to_install)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Install INLA for Bayesian SAE estimators</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">isTRUE</span>(<span class="fu">requireNamespace</span>(<span class="st">"INLA"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"INLA"</span>, <span class="at">repos=</span><span class="fu">c</span>(<span class="fu">getOption</span>(<span class="st">"repos"</span>), </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">INLA=</span><span class="st">"https://inla.r-inla-download.org/R/stable"</span>), <span class="at">dep=</span><span class="cn">TRUE</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sae)          <span class="co"># Small area estimation models</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emdi)         <span class="co"># Example datasets</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(saeTrafo)     <span class="co"># For domain sizes</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SUMMER)       <span class="co"># Bayesian SAE</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)       <span class="co"># Survey designs</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)        <span class="co"># For data wrangling</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)        <span class="co"># For data wrangling</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)        <span class="co"># For data wrangling</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)           <span class="co"># For mapping</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)      <span class="co"># For visualisations</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hrbrthemes)   <span class="co"># For visualisations</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)       <span class="co"># For visualisations</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)    <span class="co"># For visualisations</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)      <span class="co"># For visualisations</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)      <span class="co"># For visualisations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this practical we will put into practice the concepts we learnt on the theoretical session of the workshop. Using survey data, we will calculate direct and model-based income estimators. We will explore the different alternatives available when implementing these methods, which will help us choose the most adequate option given data availability. To better understand the implications of using different models, we will compare the results of the estimates generated through different methods. You can access the <code>.qmd</code> document for this practical from <a href="https://github.com/cpeiretgarcia/SAE_workshop_CUPUM/blob/main/practical.qmd">this link</a>.</p>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<p>For this workshop we will be using the European Union Statistics on Income and Living Conditions (EU-SILC). Specifically, we will be using the Austrian EU-SILC data sets available through the <code>emdi</code> package. EU-SILC provides detailed information on attributes related to income, material deprivation, labour, housing, childcare, health, access to and use of services, and education.</p>
<p>From the package <code>emdi</code> we can load a set of data related to the EU-SILC survey. <code>eusilcA_smp</code> is the random independent sample, where each row represents one individual, and each column represents a unit-level attribute. In total, the sample comprises 1,945 individuals. <code>eusilcA_popAgg</code> comprises the area-level covariates for all domains<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. <code>eusilcA_pop</code> is the total population – it comprises 25,000 observations which we will assume add up to the total population of Austria for this example. Finally, <code>eusilcA_prox</code> is the adjacency matrix for every district in Austria.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"eusilcA_smp"</span>)     <span class="co"># Random independent Sample</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"eusilcA_popAgg"</span>)  <span class="co"># Aggregated covariates at district level</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"eusilcA_pop"</span>)     <span class="co"># Population level data</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"eusilcA_prox"</span>)    <span class="co"># Adjacency matrix</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"eusilcA_smpAgg"</span>)  <span class="co"># Aggregated sample data</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Recode the domain variable as character</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>eusilcA_smp<span class="sc">$</span>district <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(eusilcA_smp<span class="sc">$</span>district)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>eusilcA_smp<span class="sc">$</span>district <span class="ot">&lt;-</span> <span class="fu">as.character</span>(eusilcA_smp<span class="sc">$</span>district)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us start by having a look at the sample data <code>eusilcA_smp</code>. Each row in the sample represents one individual, and for each of them we have information on a wide range of economic and demographic attributes. In this practical, our <strong>target variable</strong> will be the the equivalised household income (<code>eqIncome</code>), which represents the household income adjusted by household composition characteristics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(eusilcA_smp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    eqIncome gender eqsize     cash self_empl unempl_ben age_ben surv_ben
213 23485.32   male    2.5 33003.39      0.00          0       0        0
194 22704.46   male    2.0 20073.23      0.00          0       0        0
258 25946.34 female    1.0     0.00  24736.06          0       0        0
460 16152.54   male    2.1 19972.35      0.00          0       0        0
798 22587.48   male    1.5 21503.23      0.00          0       0        0
447 20437.04   male    2.0 22282.23      0.00          0       0        0
    sick_ben dis_ben rent fam_allow house_allow  cap_inv   tax_adj      state
213        0       0    0      0.00        0.00 17158.84 -10972.65 Burgenland
194        0       0    0      0.00        0.00     4.70   -940.77 Burgenland
258        0       0    0      0.00     1083.95   126.33      0.00 Burgenland
460        0       0    0   5247.33        0.00   195.32      0.00 Burgenland
798        0       0    0   2031.03        0.00    19.92      0.00 Burgenland
447        0       0    0      0.00     3312.42     0.00      0.00 Burgenland
           district weight
213 Neusiedl am See 9.6875
194 Neusiedl am See 9.6875
258 Neusiedl am See 9.6875
460 Neusiedl am See 9.6875
798 Neusiedl am See 9.6875
447 Neusiedl am See 9.6875</code></pre>
</div>
</div>
<p>We can also have a look at the spatial distribution of the observations in the sample.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="practical_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see that the observations are unequally distributed across the different districts. We see higher sample sizes in larger cities, specially in Vienna, the capital and most populous city in the country. Furthermore, we have 24 districts that are not represented in the sample:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if all districts in the population are in the sample</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(eusilcA_popAgg<span class="sc">$</span>Domain <span class="sc">%in%</span> <span class="fu">unique</span>(eusilcA_smp<span class="sc">$</span>district))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
FALSE  TRUE 
   24    70 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View all districts in the sample</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">unique</span>(eusilcA_smp<span class="sc">$</span>district))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   unique(eusilcA_smp$district)
1               Neusiedl am See
2                      Oberwart
3                     Amstetten
4                         Baden
5           Bruck an der Leitha
6                   Gänserndorf
7                    Hollabrunn
8                    Korneuburg
9                  Krems (Land)
10                         Melk
11                   Mistelbach
12                      Mödling
13                  Neunkirchen
14          Sankt Pölten (Land)
15         Sankt Pölten (Stadt)
16                        Tulln
17       Wiener Neustadt (Land)
18                         Wien
19            Klagenfurt (Land)
20           Klagenfurt (Stadt)
21       Sankt Veit an der Glan
22          Spittal an der Drau
23              Villach (Stadt)
24                 Villach Land
25                  Völkermarkt
26                    Wolfsberg
27           Bruck-Mürzzuschlag
28             Deutschlandsberg
29                Graz-Umgebung
30                 Graz (Stadt)
31         Hartberg-Fürstenfeld
32                     Leibnitz
33                       Leoben
34                       Liezen
35                       Murtal
36             Südoststeiermark
37                    Voitsberg
38                         Weiz
39               Braunau am Inn
40                    Freistadt
41                      Gmunden
42                 Grieskirchen
43       Kirchdorf an der Krems
44                    Linz-Land
45                 Linz (Stadt)
46                         Perg
47             Ried im Innkreis
48                     Rohrbach
49                    Schärding
50                   Steyr-Land
51              Urfahr-Umgebung
52                  Vöcklabruck
53                    Wels-Land
54                 Wels (Stadt)
55                      Hallein
56            Salzburg-Umgebung
57             Salzburg (Stadt)
58       Sankt Johann im Pongau
59                  Zell am See
60                         Imst
61             Innsbruck (Land)
62            Innsbruck (Stadt)
63                    Kitzbühel
64                     Kufstein
65                        Lienz
66                       Schwaz
67                      Bludenz
68                      Bregenz
69                     Dornbirn
70                    Feldkirch</code></pre>
</div>
</div>
<p>This is a relevant fact, since it will significantly affect the results and even the implementation of some SAE methods –remember that direct methods only generate outputs for areas with sampled observations.</p>
<p>Our target variable <code>eqIncome</code> follows a skewed distribution, with majority of individuals concentrated around lower income values (€ 20,000). We see very high agreement between sample values and population values.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="practical_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now that we have a better understanding of the data, we can start calculating our estimators.</p>
</section>
<section id="direct-estimator" class="level1">
<h1>Direct estimator</h1>
<p>We will start by computing the most simple SAE estimator – the direct estimator. Direct estimators use only information collected from the domain of interest. They are relatively simple to obtain, since they use the sample weights and population values. However, they are very sensitive to small sample sizes.</p>
<p>To demonstrate how the direct estimator works, we will first compute it manually but following the Horvitz-Thompson estimator of domain means and its formula:</p>
<p><span class="math display">\[
\hat{\bar{Y_d}} = \frac{1}{N_d} \sum_{i \in s_d} w_{di}Y_{di}
\]</span></p>
<p>where <span class="math inline">\(N_d\)</span> is the population at the domain of interest <span class="math inline">\(d\)</span>; <span class="math inline">\(s_d\)</span> is the set of sampled observations in domain <span class="math inline">\(d\)</span>; <span class="math inline">\(w_{di}\)</span> is the sample weight for unit <span class="math inline">\(i\)</span> in domain <span class="math inline">\(d\)</span>; and <span class="math inline">\(Y_{di}\)</span> is the observation of the target variable for unit <span class="math inline">\(i\)</span> in domain <span class="math inline">\(d\)</span>, for all <span class="math inline">\(i\)</span> in <span class="math inline">\(S_d\)</span>.</p>
<p>Before we manually calculate the direct estimator, we will have a closer look at the sampling weights (<span class="math inline">\(w_{di}\)</span>). These values represent the survey weigths, and we can find them in the <code>weights</code> column of our sample data set <code>eusilcA_smp</code>. In our survey, the weights are calculated as the inverse probabilities of selection or, in other words, the inverse of the likelyhood of an individual of the population being sampled. The value indicates the number of survey respondents in the population. This information can usually be found in the documentation of the survey, together with any clusters or strata that might have been defined by the surveyors.</p>
<p>These <em>design weights</em> can be calculated following this formula:</p>
<p><span class="math display">\[
weight_i = \frac{N_d}{n_d}
\]</span></p>
<p>To manually calculate the weights, we can do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that each district has different weights assigned</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Count number of times each weigth repeats itself in the sample (in total we should get 70 rows)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>weights_per_district <span class="ot">&lt;-</span> eusilcA_smp <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(district, weight) <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(weights_per_district)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 70</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the weights manually</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Count population per district</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>pop_count <span class="ot">&lt;-</span> eusilcA_pop <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(district, <span class="at">name =</span> <span class="st">"N_d"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Count sample per district</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>smp_count <span class="ot">&lt;-</span> eusilcA_smp <span class="sc">|&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(district, <span class="at">name =</span> <span class="st">"n_d"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Merge and calculate weight</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>weight_check <span class="ot">&lt;-</span> <span class="fu">left_join</span>(smp_count, pop_count, <span class="at">by =</span> <span class="st">"district"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calculated_weight =</span> N_d <span class="sc">/</span> n_d)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Add weights from sample and check they are the same</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>weight_check <span class="sc">|&gt;</span> </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(weights_per_district, <span class="at">by =</span> <span class="st">"district"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weights_diff =</span> calculated_weight <span class="sc">-</span> weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 district n_d  N_d calculated_weight    weight  weights_diff
1               Amstetten  33  321          9.727273  9.727273  0.000000e+00
2                   Baden  40  398          9.950000  9.950000  0.000000e+00
3                 Bludenz  17  162          9.529412  9.529412  0.000000e+00
4          Braunau am Inn  29  282          9.724138  9.724138 -1.776357e-15
5                 Bregenz  34  338          9.941176  9.941176  0.000000e+00
6     Bruck an der Leitha  27  265          9.814815  9.814815  0.000000e+00
7      Bruck-Mürzzuschlag  29  286          9.862069  9.862069  0.000000e+00
8        Deutschlandsberg  17  170         10.000000 10.000000  0.000000e+00
9                Dornbirn  22  219          9.954545  9.954545  0.000000e+00
10              Feldkirch  27  266          9.851852  9.851852 -1.776357e-15
11              Freistadt  19  187          9.842105  9.842105  1.776357e-15
12                Gmunden  29  286          9.862069  9.862069  0.000000e+00
13           Graz (Stadt)  74  734          9.918919  9.918919  0.000000e+00
14          Graz-Umgebung  41  402          9.804878  9.804878  0.000000e+00
15           Grieskirchen  18  180         10.000000 10.000000  0.000000e+00
16            Gänserndorf  28  274          9.785714  9.785714  0.000000e+00
17                Hallein  19  182          9.578947  9.578947  0.000000e+00
18   Hartberg-Fürstenfeld  26  252          9.692308  9.692308 -1.776357e-15
19             Hollabrunn  15  144          9.600000  9.600000  0.000000e+00
20                   Imst  16  151          9.437500  9.437500  0.000000e+00
21       Innsbruck (Land)  45  445          9.888889  9.888889  0.000000e+00
22      Innsbruck (Stadt)  32  318          9.937500  9.937500  0.000000e+00
23 Kirchdorf an der Krems  16  160         10.000000 10.000000  0.000000e+00
24              Kitzbühel  17  164          9.647059  9.647059 -1.776357e-15
25      Klagenfurt (Land)  19  181          9.526316  9.526316  0.000000e+00
26     Klagenfurt (Stadt)  30  293          9.766667  9.766667  0.000000e+00
27             Korneuburg  25  245          9.800000  9.800000  1.776357e-15
28           Krems (Land)  16  160         10.000000 10.000000  0.000000e+00
29               Kufstein  27  269          9.962963  9.962963  1.776357e-15
30               Leibnitz  23  222          9.652174  9.652174  0.000000e+00
31                 Leoben  18  173          9.611111  9.611111  0.000000e+00
32                  Lienz  14  131          9.357143  9.357143  0.000000e+00
33                 Liezen  23  225          9.782609  9.782609  0.000000e+00
34           Linz (Stadt)  55  546          9.927273  9.927273  0.000000e+00
35              Linz-Land  40  400         10.000000 10.000000  0.000000e+00
36                   Melk  22  218          9.909091  9.909091  0.000000e+00
37             Mistelbach  22  211          9.590909  9.590909  0.000000e+00
38                 Murtal  21  206          9.809524  9.809524  0.000000e+00
39                Mödling  33  327          9.909091  9.909091  0.000000e+00
40            Neunkirchen  25  244          9.760000  9.760000  0.000000e+00
41        Neusiedl am See  16  155          9.687500  9.687500  0.000000e+00
42               Oberwart  15  150         10.000000 10.000000  0.000000e+00
43                   Perg  19  189          9.947368  9.947368  0.000000e+00
44       Ried im Innkreis  17  168          9.882353  9.882353  0.000000e+00
45               Rohrbach  17  163          9.588235  9.588235  0.000000e+00
46       Salzburg (Stadt)  46  459          9.978261  9.978261  0.000000e+00
47      Salzburg-Umgebung  46  452          9.826087  9.826087  0.000000e+00
48 Sankt Johann im Pongau  25  247          9.880000  9.880000  0.000000e+00
49    Sankt Pölten (Land)  36  359          9.972222  9.972222 -1.776357e-15
50   Sankt Pölten (Stadt)  15  149          9.933333  9.933333  0.000000e+00
51 Sankt Veit an der Glan  18  174          9.666667  9.666667  0.000000e+00
52                 Schwaz  22  211          9.590909  9.590909  0.000000e+00
53              Schärding  17  162          9.529412  9.529412  0.000000e+00
54    Spittal an der Drau  25  242          9.680000  9.680000  0.000000e+00
55             Steyr-Land  17  170         10.000000 10.000000  0.000000e+00
56       Südoststeiermark  25  243          9.720000  9.720000  1.776357e-15
57                  Tulln  28  277          9.892857  9.892857 -1.776357e-15
58        Urfahr-Umgebung  24  235          9.791667  9.791667 -1.776357e-15
59        Villach (Stadt)  19  184          9.684211  9.684211  0.000000e+00
60           Villach Land  20  199          9.950000  9.950000  0.000000e+00
61              Voitsberg  15  146          9.733333  9.733333 -1.776357e-15
62            Vöcklabruck  38  375          9.868421  9.868421  0.000000e+00
63            Völkermarkt  14  131          9.357143  9.357143  0.000000e+00
64                   Weiz  25  246          9.840000  9.840000  0.000000e+00
65           Wels (Stadt)  17  169          9.941176  9.941176  0.000000e+00
66              Wels-Land  20  196          9.800000  9.800000  1.776357e-15
67                   Wien 200 5857         29.285000 29.285000  3.552714e-15
68 Wiener Neustadt (Land)  22  215          9.772727  9.772727  0.000000e+00
69              Wolfsberg  17  168          9.882353  9.882353  0.000000e+00
70            Zell am See  27  266          9.851852  9.851852 -1.776357e-15</code></pre>
</div>
</div>
<p>The <code>weights_diff</code> column is the difference between our manually calculated weights (<code>calculated_weight</code>) and the survey weights (<code>weight</code>). We can see that the values are either zero or very close to zero (this minimal difference is due to rounding differences), which proves that the weights in the survey were calculated as the inverse probability of selection.</p>
<p>Let us now calculate the direct estimator manually:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate total population values for sampled domains</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> pop_count <span class="sc">|&gt;</span> <span class="fu">filter</span>(pop_count<span class="sc">$</span>district <span class="sc">%in%</span> eusilcA_smp<span class="sc">$</span>district)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Add N to the sample data</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>dir_df <span class="ot">&lt;-</span> eusilcA_smp <span class="sc">|&gt;</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(N, <span class="at">by =</span> <span class="st">"district"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(district, eqIncome, weight, N_d)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate direct estimator manually for each domain</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>manual_direct <span class="ot">&lt;-</span> dir_df <span class="sc">|&gt;</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w_Y =</span> weight <span class="sc">*</span> eqIncome) <span class="sc">|&gt;</span> </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(district, N_d) <span class="sc">|&gt;</span> </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">sum_wY =</span> <span class="fu">sum</span>(w_Y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dir_est_manual =</span> sum_wY <span class="sc">/</span> N_d)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co"># See results</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(manual_direct)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  district              N_d    sum_wY dir_est_manual
  &lt;chr&gt;               &lt;int&gt;     &lt;dbl&gt;          &lt;dbl&gt;
1 Amstetten             321  4879568.         15201.
2 Baden                 398  9122834.         22922.
3 Bludenz               162  1955274.         12070.
4 Braunau am Inn        282  3437608.         12190.
5 Bregenz               338 12077145.         35731.
6 Bruck an der Leitha   265  6294628.         23753.</code></pre>
</div>
</div>
<p>Now, we will calculate the direct estimator using the <code>sae</code> package. The <code>direct()</code> function computes the Horvitz-Thompson estimator, the same one we have just manually computed. In addition to the direct estimator of the mean, the <code>direct()</code> function also gives us the standard deviation and coefficient of variation for each domain.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the direct estimator manually</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sae_direct <span class="ot">&lt;-</span> sae<span class="sc">::</span><span class="fu">direct</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> eusilcA_smp<span class="sc">$</span>eqIncome,        <span class="co"># Individual values of the target variable</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">dom =</span> eusilcA_smp<span class="sc">$</span>district,      <span class="co"># Domain names</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sweight =</span> eusilcA_smp<span class="sc">$</span>weight,    <span class="co"># Sampling weights</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">domsize =</span> N,                     <span class="co"># Data frame with domain names and the corresponding population sizes.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">replace =</span> <span class="cn">FALSE</span>                  <span class="co"># Sampling conducted without replacement</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># See results</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sae_direct)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Domain SampSize   Direct       SD       CV
3            Amstetten       33 15201.15 2723.329 17.91528
4                Baden       40 22921.69 3564.496 15.55075
67             Bludenz       17 12069.59 2956.478 24.49526
39      Braunau am Inn       29 12190.10 2294.239 18.82051
68             Bregenz       34 35731.20 6084.361 17.02815
5  Bruck an der Leitha       27 23753.31 4475.512 18.84163</code></pre>
</div>
</div>
<p>Once we have calculated the direct estimator manually and using the pre-defined <code>direct()</code> function of the <code>sae</code> package, we can compare the results</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join both into a single data frame</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>direct_compare <span class="ot">&lt;-</span> <span class="fu">left_join</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> sae_direct[,<span class="fu">c</span>(<span class="st">"Domain"</span>, <span class="st">"Direct"</span>)],</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> manual_direct[,<span class="fu">c</span>(<span class="st">"district"</span>, <span class="st">"dir_est_manual"</span>)],</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Domain"</span> <span class="ot">=</span> <span class="st">"district"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare values</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> direct_compare) <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> Direct, <span class="at">y =</span> dir_est_manual)) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"`sae` direct estimator vs manual direct estimator"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"`sae` direct estimator"</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Manual direct estimator"</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="practical_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows a perfect match between the manually computed direct estimator values and the values from the <code>direct()</code> function of the <code>sae</code> package. Now that we have tested how the <code>sae</code> function works under the hood, we can plot our results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add confidence intervals</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>sae_direct_ci <span class="ot">&lt;-</span> sae_direct <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> Direct <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> SD,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> Direct <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> SD</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sae_direct_ci, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Domain, Direct), <span class="at">y =</span> Direct)) <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">colour =</span> <span class="st">"gray"</span>, <span class="at">width =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"#264653"</span>) <span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"District"</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Equivalised income (Direct Estimate)"</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Direct Estimates of Equivalised Income (95% CI)"</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">lineheight =</span> <span class="fl">1.5</span>)  <span class="co"># Default is 1, try 1.3–2</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="practical_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows the value of the direct estimator and the confidence interval around that value. The confidence interval is calculated as the mean plus and minus the standard deviation multiplied by a constant value (1.96) that comes from the standard normal distribution at a 95% confidence interval. The interval represents all the possible ``true values’’ of our estimator. Longer error bars indicate higher uncertainty around the values –there is a larger range of potential true values– while shorter error bars indicate lower uncertainty –the range of potential values is more constrained.</p>
<p>The advantage of using the <code>sae</code> package is that it allows us to easily implement variations of the direct estimate calculation. In some cases, the survey might have been conducted following different surveying strategies in a more flexible way. For instance, it might be that the sampling was conducted with replacement, instead of without replacement [^2], or it could be that we do not have access to the domain of interest population sizes, in which case we would have to proceed differently to calculate our direct es</p>
<p>[^2] Survey sampling –selecting individuals from the total population for a survey– can be done with or without replacement. Sampling without replacement means that individuals from a domain can only be sampled once (imagine we take a ball out of a bag and we do not put it back); or with replacement (we take a ball out of the bag and put it back).</p>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Remember that a domain refers to a small geographic area or a subpopulation (e.g., age group or income class) for which we want to calculate the small area estimation.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>